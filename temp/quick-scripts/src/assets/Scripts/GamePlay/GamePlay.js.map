{"version":3,"sources":["assets\\Scripts\\GamePlay\\GamePlay.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\n\r\nimport { CONST } from \"../Const/CONST\";\r\nimport GameInfo from \"../Const/GameInfo\";\r\nimport { GameController } from \"../Controller/GameController\";\r\nimport { SoundController } from \"../Controller/SoundController\";\r\nimport { UIController } from \"../Controller/UIController\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport class GamePlay extends cc.Component {\r\n    @property(GameController)\r\n    GameController: GameController = null;\r\n    @property(UIController)\r\n    UIController: UIController = null;\r\n\r\n    @property([cc.Node])\r\n    Items: cc.Node[] = [];\r\n\r\n    @property(cc.Node)\r\n    buttonResult: cc.Node = null;\r\n    @property(cc.Node)\r\n    resultNode: cc.Node = null;\r\n\r\n\r\n    protected onLoad(): void {\r\n\r\n    }\r\n\r\n\r\n    protected start(): void {\r\n\r\n        // debug\r\n        this.scheduleOnce(() => {\r\n            this.checkGridResult() && this.win();\r\n        }, 1) \r\n\r\n        this.registerEvent()\r\n\r\n    }\r\n\r\n\r\n    private registerEvent(): void {\r\n        this.buttonResult.on(cc.Node.EventType.TOUCH_START, this.handleShowHint, this);\r\n\r\n        this.UIController.Grid.children.forEach((item) => {\r\n            const item_mask = item.getChildByName(\"Mask\");\r\n            const index = this.getTrailingNumber(item.name);\r\n            GameInfo.Grid.currentStates[index - 1].currentItem = item;\r\n            item_mask.on(cc.Node.EventType.TOUCH_START, () => this.handleItemClick(index - 1), this);\r\n        });\r\n    }\r\n\r\n\r\n    private offEvent(): void {\r\n        this.buttonResult.off(cc.Node.EventType.TOUCH_START);\r\n\r\n        this.UIController.Grid.children.forEach((item) => {\r\n            const item_mask = item.getChildByName(\"Mask\");\r\n            item_mask.off(cc.Node.EventType.TOUCH_START);\r\n        });\r\n    }\r\n\r\n\r\n    private handleStopUserClickBehavior(): void {\r\n        GameInfo.isCanTouch = false;\r\n\r\n        this.scheduleOnce(() => GameInfo.isCanTouch = true, 1.1)\r\n    }\r\n\r\n\r\n    private handleShowHint(): void {\r\n        if (!GameInfo.isCanTouch) return;\r\n\r\n        this.handleStopUserClickBehavior();\r\n\r\n        this.resultNode.getComponent(cc.Animation).play();\r\n\r\n        SoundController.Instance(SoundController).playSound(CONST.SoundTrack.clickBtnSound)\r\n    }\r\n\r\n\r\n    private getTrailingNumber(string: string): number {\r\n        const match = string.match(/\\d+$/); // Tìm số ở cuối chuỗi\r\n        return match ? parseInt(match[0], 10) : null;\r\n    }\r\n\r\n\r\n    private handleItemClick(index: number): void {\r\n        if (!GameInfo.isCanTouch) return;\r\n\r\n        const emptyIndex = GameInfo.Grid.currentStates.findIndex(state => state.isNull);\r\n\r\n        // Kiểm tra nếu ô được click là Neighbor của ô trống\r\n        if (this.isNeighbor(index, emptyIndex)) {\r\n            this.updateGrid(index, emptyIndex);\r\n\r\n            this.offEvent();\r\n\r\n            this.registerEvent();\r\n\r\n            this.checkGridResult() && this.win();\r\n\r\n            // cc.log(GameInfo.Grid.currentStates.map(state => state.correctItemID));\r\n            // cc.log(this.UIController.Grid.children.map(item => item.name));\r\n        } else {\r\n            cc.log(\"wrong\");\r\n\r\n            SoundController.Instance(SoundController).playSound(CONST.SoundTrack.wrongSound);\r\n        }\r\n\r\n    }\r\n\r\n\r\n    private getRowAndCol(index: number): { row: number; col: number } {\r\n        const colsPerRow = 3; // Số ô trên mỗi hàng\r\n        const row = Math.floor(index / colsPerRow);\r\n        const col = index % colsPerRow;\r\n        return { row, col };\r\n    }\r\n\r\n\r\n    private isNeighbor(index1: number, index2: number): boolean {\r\n        const { row: row1, col: col1 } = this.getRowAndCol(index1);\r\n        const { row: row2, col: col2 } = this.getRowAndCol(index2);\r\n\r\n        // cc.log(row1, row2, col1, col2);\r\n\r\n        return (row1 === row2 && Math.abs(col1 - col2) === 1) ||\r\n            (col1 === col2 && Math.abs(row1 - row2) === 1);\r\n    }\r\n\r\n\r\n    private updateGrid(index: number, emptyIndex: number): void {\r\n        GameInfo.Grid.currentStates[index].isNull = true;\r\n        GameInfo.Grid.currentStates[emptyIndex].isNull = false;\r\n\r\n        let currentNode = GameInfo.Grid.currentStates[index].currentItem;\r\n        let emptyNode = GameInfo.Grid.currentStates[emptyIndex].currentItem;\r\n\r\n        let tempName = currentNode.name;\r\n\r\n        GameInfo.Grid.currentStates[index].currentItem.name = emptyNode.name;\r\n        GameInfo.Grid.currentStates[emptyIndex].currentItem.name = tempName;\r\n\r\n        GameInfo.Grid.currentStates[index].currentItem = emptyNode;\r\n        GameInfo.Grid.currentStates[emptyIndex].currentItem = currentNode;\r\n\r\n        this.moveItem(currentNode, emptyNode);\r\n    }\r\n\r\n\r\n    private moveItem(currentNode: cc.Node, emptyNode: cc.Node): void {\r\n        cc.tween(currentNode)\r\n            .to(0.16, { position: emptyNode.position }, { easing: cc.easing.smooth })\r\n            .start();\r\n\r\n        emptyNode.setPosition(currentNode.position);\r\n\r\n        SoundController.Instance(SoundController).playSound(CONST.SoundTrack.slideSound);\r\n    }\r\n\r\n\r\n    private checkGridResult(): boolean {\r\n        const isPositionCorrect = this.UIController.Grid.children.every((item, index) => {\r\n            const correctPos = new cc.Vec3(GameInfo.Grid.currentStates[index].correctItemPos);\r\n            return this.areVec3Equal(item.getPosition(), correctPos);\r\n        });\r\n\r\n        return isPositionCorrect;\r\n    }\r\n\r\n\r\n    private areVec3Equal(vecA: cc.Vec2, vecB: cc.Vec3, epsilon = 1): boolean {\r\n        return Math.abs(vecA.x - vecB.x) <= epsilon &&\r\n               Math.abs(vecA.y - vecB.y) <= epsilon \r\n    }\r\n\r\n\r\n    private win(): void {\r\n        this.buttonResult.children.forEach(child => {\r\n            child.color = cc.color(255, 184, 0, 255);\r\n        });\r\n\r\n        this.offEvent();\r\n\r\n        cc.tween(this.resultNode)\r\n        .to(0.5, {opacity: 255}, {easing: cc.easing.smooth})\r\n        .call(() => {\r\n            let label = this.buttonResult.getComponentInChildren(cc.Label);\r\n            label.string = 'DOWNLOAD';\r\n            label.node.color = cc.color(255,255,255,255);\r\n            label.node.scale = 0.8;\r\n            this.buttonResult.on(cc.Node.EventType.TOUCH_START, this.GameController.installHandle, this);\r\n        })\r\n        .start();\r\n\r\n\r\n        cc.tween(this.buttonResult)\r\n        .repeatForever(\r\n            cc.tween(this.buttonResult)\r\n                .to(0.5, {scale: 0.3}, {easing: cc.easing.smooth})\r\n                .to(0.5, {scale: 0.35}, {easing: cc.easing.elasticOut})\r\n        ).start();\r\n    }\r\n\r\n}\r\n"]}